// Fat jar
task snapPrepare(type: Jar) {
	duplicatesStrategy = DuplicatesStrategy.EXCLUDE
	archiveFileName = "timecard-kt_fat.jar"
	destinationDirectory = file("$rootDir/build/snap")
	manifest {
		attributes "Main-Class": "app.shamilton.timecardkt.AppKt"
	}

	from {
		configurations.runtimeClasspath.collect { it.isDirectory() ? it : zipTree(it) }
	}
	with jar
}

tasks.create("snapBuild") {
    // Don't need to depend on snapPrepare - snapcraft will clone this repo and run snapPrepare
    doLast {
        def craft = new File("deploy/snap/snapcraft.yaml")
        def origCraft = new File("deploy/snap/snapcraft.yaml.orig")
        origCraft.write(craft.text)
        exec {
		workingDir rootProject.file("deploy/snap")
		commandLine "python", "version_setter.py"
        }
        exec {
		workingDir rootProject.file("deploy/snap")
		commandLine "bash", "-c", "snapcraft"
        }
        craft.delete()
        craft.write(origCraft.text)
        origCraft.delete()
    }
}

tasks.create("snapDeploy") {
    dependsOn("snapBuild")
    doLast {
        exec {
		workingDir rootProject.file("deploy/snap")
		// TODO: Figure out how to have this wildcard actually work
		commandLine "bash", "-c", "snapcraft upload timecard-kt_*.snap"
        }
    }
}
